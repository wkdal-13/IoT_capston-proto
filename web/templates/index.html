<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IoT 네트워크 보안 대시보드</title>
  <!-- 로컬 Tailwind CSS -->
  <link
    href="{{ url_for('static', filename='css/tailwind.min.css') }}"
    rel="stylesheet"
  />
  <!-- 로컬 Chart.js -->
  <script
    src="{{ url_for('static', filename='js/chart.umd.min.js') }}"
    defer
    ></script>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- 상단 네비게이션 바 -->
  <nav class="bg-white shadow-md p-4 flex justify-between items-center">
    <div class="flex items-center space-x-4">
        <img 
            src="{{ url_for('static', filename='img/raspberry-pi-logo.png') }}" 
            alt="Raspberry Pi Logo" 
            class="h-8 w-auto"
        />
    </div>
    <a href="{{ url_for('logout') }}"
       class="text-white bg-red-500 px-4 py-2 rounded hover:bg-red-600">
      로그아웃
    </a>
  </nav>

  <!-- 탭 네비게이션 -->
  <div class="bg-white shadow-md">
    <nav class="flex space-x-8 p-4">
      <button id="tab-dashboard"
              class="pb-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
        대시보드
      </button>
      <button id="tab-inspect"
              class="pb-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
        점검
      </button>
      <button id="tab-detect"
              class="pb-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
        탐지
      </button>
    </nav>
  </div>

  <!-- 콘텐츠: 대시보드 -->
  <div id="content-dashboard" class="p-8">
    <h1 class="text-3xl font-bold mb-6 text-gray-800">시스템 상태</h1>
  
    <!-- 대시보드 그리드 -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- CPU 사용률 (라인 그래프) -->
        <div class="bg-white shadow-lg rounded-lg p-6">
            <h2 class="text-lg font-bold mb-4">CPU 사용률</h2>
            <canvas id="cpuChart" style="max-height: 150px;"></canvas>
            <div class="mt-4">
                <p id="cpu-summary" class="text-sm text-gray-600">코어 사용률 요약: 0%</p>
            </div>
        </div>

        <!-- 메모리 사용량 (파이 차트) -->
        <div class="bg-white shadow-lg rounded-lg p-6">
            <h2 class="text-lg font-bold mb-4">메모리 사용량</h2>
            <canvas id="memoryChart" style="max-height: 150px;"></canvas>
            <div class="mt-4">
                <p id="memory-summary" class="text-sm text-gray-600">사용 중: 0GB, 사용 가능: 0GB</p>
           </div>
        </div>

        <!-- 디스크 사용량 (파이 차트) -->
        <div class="bg-white shadow-lg rounded-lg p-6">
            <h2 class="text-lg font-bold mb-4">디스크 사용량</h2>
            <canvas id="diskChart" style="max-height: 150px;"></canvas>
            <div class="mt-4">
                <p id="disk-summary" class="text-sm text-gray-600">사용 중: 0GB, 사용 가능: 0GB</p>
            </div>
        </div>
    </div>

    <!-- 네트워크 상태와 온도 -->
    <div class="grid grid-cols-10 gap-6 mt-6">
        <!-- 네트워크 상태 (7:3) -->
        <div class="col-span-6 bg-white shadow-lg rounded-lg p-6">
            <h2 class="text-lg font-bold mb-4">네트워크 상태</h2>
            <canvas id="networkChart" style="max-height: 200px;"></canvas>
            <div class="mt-4">
                <p id="network-summary" class="text-sm text-gray-600">송신 속도: 0MB/s, 수신 속도: 0MB/s</p>
            </div>
        </div>
      
        <!-- 온도 상태 (7:3) -->
        <div class="col-span-4 bg-white shadow-lg rounded-lg p-6 flex items-center justify-center">
            <div>
                <h2 class="text-lg font-bold mb-4 text-center">CPU 온도</h2>
                <p id="cpu-temperature" class="text-5xl font-bold text-red-500 text-center">0°C</p>
            </div>
        </div>
    </div>
  </div>

  <!-- 콘텐츠: 점검 -->
  <div id="content-inspect" class="p-8 hidden">
    <h1 class="text-3xl font-bold mb-6 text-gray-800">공유기 보안 점검</h1>
    <form action="{{ url_for('inspect') }}" method="post"
          class="space-y-4 bg-white shadow-lg rounded-lg p-6">
      <div>
        <label for="router_type" class="block text-sm font-medium text-gray-700">
          브랜드
        </label>
        <select name="router_type" id="router_type"
                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
          <option value="tplink" selected>TP-Link</option>
          <option value="iptime">IPTIME</option>
          <option value="dlink">D-Link</option>
        </select>
      </div>
      <div>
        <label for="router_ip" class="block text-sm font-medium text-gray-700">
          라우터 IP
        </label>
        <input type="text" name="router_ip" id="router_ip" required
               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"/>
      </div>
      <div id="username-field">
        <label for="username" class="block text-sm font-medium text-gray-700">
          아이디
        </label>
        <input type="text" name="username" id="username"
               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"/>
      </div>
      <div>
        <label for="password" class="block text-sm font-medium text-gray-700">
          비밀번호
        </label>
        <input type="password" name="password" id="password"
               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"/>
      </div>
      <button type="submit"
              class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
        점검 시작
      </button>
    </form>

    {% if inspect_result %}
    <div class="mt-6 bg-white shadow-lg rounded-lg p-6">
      <h2 class="text-xl font-bold mb-4">점검 결과</h2>
      <!-- pre 태그로 줄바꿈 보존(세로 나열) -->
      <pre class="whitespace-pre-wrap">{{ inspect_result }}</pre>
    </div>
    {% endif %}
  </div>

  <!-- 콘텐츠: 탐지 -->
  <div id="content-detect" class="p-8 hidden">
    <h1 class="text-3xl font-bold mb-6 text-gray-800">이상 탐지</h1>
    <form action="{{ url_for('detect') }}" method="post" enctype="multipart/form-data"
          class="space-y-4 bg-white shadow-lg rounded-lg p-6">
      <div>
        <label for="log_file" class="block text-sm font-medium text-gray-700">
          Suricata 로그 파일 업로드
        </label>
        <input type="file" name="log_file" id="log_file" accept=".csv,.log"
               required class="mt-1 block w-full text-gray-700"/>
      </div>
      <button type="submit"
              class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
        탐지 시작
      </button>
    </form>

    {% if detect_result %}
    <div class="mt-6 bg-white shadow-lg rounded-lg p-6">
      <h2 class="text-xl font-bold mb-4">탐지 결과</h2>
      <pre class="whitespace-pre-wrap">{{ detect_result }}</pre>
    </div>
    {% endif %}

    {% if detect_table %}
    <div class="mt-6 bg-white shadow-lg rounded-lg p-6">
      <h2 class="text-xl font-bold mb-4">이상 이벤트 비율 차트 & 최근 이벤트</h2>
      <canvas id="anomalyChart" style="max-height:200px;"></canvas>
      <div class="mt-4 overflow-auto">
        <h3 class="font-semibold mb-2">최근 20건 이벤트</h3>
        {{ detect_table|safe }}
      </div>
    </div>
    {% endif %}
  </div>

  <!-- 탭 전환 & Username 필드 토글 & 초기 선택 -->
  <script>
    const tabs = ['dashboard','inspect','detect'];
    function selectTab(tab) {
      tabs.forEach(t => {
        const btn  = document.getElementById('tab-'+t);
        const pane = document.getElementById('content-'+t);
        if (t === tab) {
          btn.classList.add('border-blue-500','text-blue-600','font-medium');
          btn.classList.remove('border-transparent','text-gray-500');
          pane.classList.remove('hidden');
        } else {
          btn.classList.remove('border-blue-500','text-blue-600','font-medium');
          btn.classList.add('border-transparent','text-gray-500');
          pane.classList.add('hidden');
        }
      });
    }
    // 클릭 이벤트
    tabs.forEach(tab => {
      document.getElementById('tab-'+tab)
              .addEventListener('click', () => selectTab(tab));
    });
    // TP-Link 선택 시 아이디 필드 숨기기
    const routerTypeSelect = document.getElementById('router_type');
    const usernameField = document.getElementById('username-field');
    function toggleUsernameField() {
      usernameField.style.display =
        routerTypeSelect.value === 'tplink' ? 'none' : 'block';
    }
    routerTypeSelect.addEventListener('change', toggleUsernameField);
    // 초기 로드 시
    document.addEventListener('DOMContentLoaded', () => {
      toggleUsernameField();
      // 서버가 넘기는 active_tab 값으로 초기 탭 선택
      selectTab("{{ active_tab }}");
    });
  </script>

  <script>
  // 차트 설정
  const cpuChart = new Chart(document.getElementById('cpuChart'), {
      type: 'line',
      data: {
          labels: Array.from({ length: 10 }, (_, i) => `T-${10 - i}`),
          datasets: []
      },
      options: {
          responsive: true,
          plugins: {
              legend: { display: true, position: 'top' }
          },
          scales: {
              y: { beginAtZero: true, max: 100 }
          }
      }
  });

  const memoryChart = new Chart(document.getElementById('memoryChart'), {
      type: 'pie',
      data: {
          labels: ['사용 중', '사용 가능'],
          datasets: [{
              data: [0, 100],
              backgroundColor: ['#4CAF50', '#E0E0E0']
          }]
      },
      options: {
          responsive: true,
          plugins: {
              legend: { display: true, position: 'top' }
          }
      }
  });

  const diskChart = new Chart(document.getElementById('diskChart'), {
      type: 'pie',
      data: {
          labels: ['사용 중', '사용 가능'],
          datasets: [{
              data: [0, 100],
              backgroundColor: ['#2196F3', '#E0E0E0']
          }]
      },
      options: {
          responsive: true,
          plugins: {
              legend: { display: true, position: 'top' }
          }
      }
  });

  const networkChart = new Chart(document.getElementById('networkChart'), {
      type: 'line',
      data: {
          labels: Array.from({ length: 10 }, (_, i) => `T-${10 - i}`),
          datasets: [
              {
                  label: '송신 속도 (MB/s)',
                  data: Array(10).fill(0),
                  fill: false,
                  borderColor: '#4CAF50'
              },
              {
                  label: '수신 속도 (MB/s)',
                  data: Array(10).fill(0),
                  fill: false,
                  borderColor: '#2196F3'
              }
          ]
      },
      options: {
          responsive: true,
          plugins: {
              legend: { display: true, position: 'top' }
          },
          scales: {
              y: { beginAtZero: true }
          }
      }
  });
  function updateTemperatureColor(temp) {
      const tempElement = document.getElementById('cpu-temperature');
      if (temp < 40) {
          tempElement.className = 'text-7xl font-bold text-green-500 text-center';
      } else if (temp < 70) {
          tempElement.className = 'text-7xl font-bold text-yellow-500 text-center';
      } else {
          tempElement.className = 'text-7xl font-bold text-red-500 text-center';
      }
  }
  // 데이터 갱신
  function fetchSystemInfo() {
      fetch('/system_info')
          .then(response => response.json())
          .then(data => {
              // CPU 데이터 갱신
              if (!cpuChart.data.datasets.length) {
                  data.cpu.per_core_percent.forEach((_, i) => {
                      cpuChart.data.datasets.push({
                          label: `Core ${i}`,
                          data: Array(10).fill(0),
                          fill: false,
                          borderColor: `hsl(${(i * 60) % 360}, 70%, 50%)`
                      });
                  });
              }
              data.cpu.per_core_percent.forEach((usage, i) => {
                  cpuChart.data.datasets[i].data.push(usage);
                  if (cpuChart.data.datasets[i].data.length > 10) {
                      cpuChart.data.datasets[i].data.shift();
                  }
              });
              cpuChart.update();
              const avgCpuUsage = (data.cpu.per_core_percent.reduce((a, b) => a + b, 0) / data.cpu.per_core_percent.length).toFixed(2);
              document.getElementById('cpu-summary').textContent = `코어 사용률 요약: ${avgCpuUsage}%`;

              // 메모리 데이터 갱신
              memoryChart.data.datasets[0].data = [
                  data.memory.used / (1024 ** 3), 
                  data.memory.available / (1024 ** 3)
              ];
              memoryChart.update();
              document.getElementById('memory-summary').textContent = `사용 중: ${(data.memory.used / (1024 ** 3)).toFixed(2)}GB, 사용 가능: ${(data.memory.available / (1024 ** 3)).toFixed(2)}GB`;

              // 디스크 데이터 갱신
              diskChart.data.datasets[0].data = [
                  data.disk.used / (1024 ** 3), 
                  (data.disk.total - data.disk.used) / (1024 ** 3)
              ];
              diskChart.update();
              document.getElementById('disk-summary').textContent = `사용 중: ${(data.disk.used / (1024 ** 3)).toFixed(2)}GB, 사용 가능: ${((data.disk.total - data.disk.used) / (1024 ** 3)).toFixed(2)}GB`;

              // 네트워크 데이터 갱신
              networkChart.data.datasets[0].data.push(data.network.bytes_sent / (1024 ** 2));
              networkChart.data.datasets[1].data.push(data.network.bytes_received / (1024 ** 2));
              if (networkChart.data.datasets[0].data.length > 10) {
                  networkChart.data.datasets[0].data.shift();
                  networkChart.data.datasets[1].data.shift();
              }
              networkChart.update();
              document.getElementById('network-summary').textContent = `송신 속도: ${(data.network.bytes_sent / (1024 ** 2)).toFixed(2)}MB/s, 수신 속도: ${(data.network.bytes_received / (1024 ** 2)).toFixed(2)}MB/s`;

              // CPU 온도 갱신
              const cpuTemp = data.hardware.cpu_temperature || 0;
              document.getElementById('cpu-temperature').textContent = `${data.hardware.cpu_temperature}°C`;
              updateTemperatureColor(cpuTemp);
          });
  }

  setInterval(fetchSystemInfo, 3000);
  fetchSystemInfo();
  </script>

  <!-- 이상 이벤트 차트 -->
  <script>
    const anomalyChart = new Chart(document.getElementById('anomalyChart'), {
      type:'bar',
      data:{ labels:[], datasets:[{ label:'이상 이벤트 비율(%)', data:[] }] },
      options:{ responsive:true }
    });
    function updateAnomalyChart(){
      fetch('/anomaly_stats')
        .then(res=>res.json())
        .then(data=>{
          if(data.error) return console.error(data.error);
          anomalyChart.data.labels = data.timestamps;
          anomalyChart.data.datasets[0].data = data.ratio;
          anomalyChart.update();
        })
        .catch(console.error);
    }
    setInterval(updateAnomalyChart,10000);
    updateAnomalyChart();
  </script>

</body>
</html>
